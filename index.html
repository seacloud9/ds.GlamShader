<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>threeJS PostProcessing adn Audio Demo</title>
		<meta charset="utf-8">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				overflow: hidden;
			}
		</style>
		<script>(function main() {
    function fireEnabledEvent() {
        if (!window.gli) {
            setTimeout(function () {
                var enabledEvent = document.createEvent("Event");
                enabledEvent.initEvent("WebGLEnabledEvent", true, true);
                document.dispatchEvent(enabledEvent);
            }, 0);
        } else {
            alert('this website requires webGL')
        }
    };

    document.addEventListener("WebGLInspectorReadyEvent", function (e) {
        var pathElement = document.getElementById("__webglpathroot");
        if (window["gliloader"]) {
            gliloader.pathRoot = pathElement.innerText;
        } else {
            window.gliCssUrl = pathElement.innerText + "gli.all.css";
        }
    }, false);

    var originalGetContext = HTMLCanvasElement.prototype.getContext;
    if (!HTMLCanvasElement.prototype.getContextRaw) {
        HTMLCanvasElement.prototype.getContextRaw = originalGetContext;
    }
    HTMLCanvasElement.prototype.getContext = function () {
        var ignoreCanvas = this.internalInspectorSurface;
        if (ignoreCanvas) {
            return originalGetContext.apply(this, arguments);
        }

        var result = originalGetContext.apply(this, arguments);
        if (result == null) {
            return null;
        }

        var contextNames = ["moz-webgl", "webkit-3d", "experimental-webgl", "webgl", "3d"];
        var requestingWebGL = contextNames.indexOf(arguments[0]) != -1;
        if (requestingWebGL) {
            fireEnabledEvent(this);
            if (window.gli) {
                if (gli.host.inspectContext) {
                    result = gli.host.inspectContext(this, result);
                    window.setTimeout(function() {
                        var hostUI = new gli.host.HostUI(result);
                        result.hostUI = hostUI; 
                    }, 0);
                }
            }
        }

        return result;
    };
})();</script>
<script src="scripts/processing.js" type="text/javascript"></script>
		<script src="http://connect.soundcloud.com/sdk.js"></script>
	</head>
	<body >
	
		<div id="container"></div>
		<div id="glamProcessing" width="512" height="512" style="display:none"></div>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="scripts/webaudio.js"></script>
		<script src="scripts/three.min.js"></script>
		<script src="scripts/stats.min.js"></script>
		<script src="scripts/CopyShader.js"></script>
		<script src="scripts/DotScreenShader.js"></script>
		<script src="scripts/RGBShiftShader.js"></script>
		<script src="scripts/MirrorShader.js"></script>
		<script src="scripts/EffectComposer.js"></script>
		<script src="scripts/RenderPass.js"></script>
		<script src="scripts/MaskPass.js"></script>
		<script src="scripts/ShaderPass.js"></script>
		<script src='scripts/ConvolutionShader.js'></script>
		<script src="scripts/BloomPass.js"></script>
		<script src="scripts/tweeneasing.js"></script>
		<script>

	
			var camera, scene, renderer, postprocessor, stats, sound, soundAPI, webaudio, data, processingMat;
			var mirrorParams, mirrorPass, clock = new THREE.Clock();
			var object, light, scaleSound = 0;

			function getRandomArbitrary(min, max) {
			  return Math.random() * (max - min) + min;
			}


			function init() {
				
				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );
				camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.z = 400;
				scene = new THREE.Scene();
				scene.fog = new THREE.Fog( 0x000000, 1, 1000 );
				object = new THREE.Object3D();
				scene.add( object );
				

				scene.add( new THREE.AmbientLight( 0x222222 ) );

				light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 1, 1, 1 );
				scene.add( light );

				// postprocessing

				postprocessor = new THREE.EffectComposer( renderer );
				postprocessor.addPass( new THREE.RenderPass( scene, camera ) );
				effectBloom = new THREE.BloomPass(30.25, 10, 5, 1024);
				effectBloom.enabled = false;
				postprocessor.addPass( effectBloom );
				effectBloom.renderToScreen = true;

				addSpaceJunk();

				

				mirrorPass = new THREE.ShaderPass( THREE.MirrorShader );
				mirrorPass.uniforms[ "side" ].value = 1;
				postprocessor.addPass( mirrorPass );
				mirrorPass.renderToScreen = true;

				
				
				
				dotScreenPass = new THREE.ShaderPass( THREE.DotScreenShader );
				dotScreenPass.uniforms[ 'scale' ].value = 4;
				dotScreenPass.enabled = false;
				postprocessor.addPass( dotScreenPass );

		
				rGBShiftPass = new THREE.ShaderPass( THREE.RGBShiftShader );
				rGBShiftPass.uniforms[ 'amount' ].value = 0.0015;
				rGBShiftPass.renderToScreen = true;
				rGBShiftPass.enabled = false;
				postprocessor.addPass( rGBShiftPass );
			
				

		
				//
				

				window.addEventListener( 'resize', onWindowResize, false );

			}


			function addSpaceJunk(){

				for ( var i = 0; i < 80; i ++ ) {
					if(i % 2 === 0){
						scale = getRandomArbitrary(1, 6);
						var geo = new THREE.SphereGeometry( 1, scale, scale );
						var mesh = new THREE.Mesh( geo, processingMat );
					}else{

						scale = getRandomArbitrary(0.75, 2);
						var geo2 = new THREE.BoxGeometry( scale, scale, scale );
						var mesh = new THREE.Mesh( geo2, processingMat );
					}
					wrapTexture();
					mesh.position.set( Math.random() - 0.5, Math.random() - 0.5, Math.random() - 0.5 ).normalize();
					mesh.position.multiplyScalar( Math.random() * 400 );
					mesh.rotation.set( Math.random() * 2, Math.random() * 2, Math.random() * 2 );
					mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 50;
					object.add( mesh );

				}

			}
			function wrapTexture(){
				canvas = document.getElementById('glam');
		        texture = new THREE.Texture(canvas);
		        texture.needsUpdate = true;

		        processingMat = new THREE.MeshBasicMaterial({
		         overdraw:true, map:texture, side:THREE.DoubleSide, transparent: true
		        });
		         texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {
				

				wrapTexture();

				for(var i=0; object.children.length > i; i++){
					object.children[i].material = processingMat;
				}

				var min		= 0;
				var max		= 1;
				var offset	= 0;
				var range	= 1;
				var tweenFn	= TWEEN.Easing.Linear.None;
				scaleSound	= soundAPI.amplitude();
				scaleSound		= Math.min(scaleSound, max);
				scaleSound		= Math.max(scaleSound, min);
				scaleSound		-= min;
				scaleSound		/= max == min ? 1 : max - min;
				scaleSound		= tweenFn(scaleSound);
				scaleSound		*= range;
				scaleSound		+= offset;

				if(scaleSound > 0){
					object.scale.set(scaleSound, scaleSound, scaleSound);
				}

				if(scaleSound > 0.5){
					effectBloom.enabled = false;
					dotScreenPass.enabled = false;
					rGBShiftPass.enabled = false;
					
				}else if(scaleSound > 0.6){
					dotScreenPass.enabled = true;
					rGBShiftPass.enabled = true;
				}else{
					effectBloom.enabled = true;
					dotScreenPass.enabled = false;
					rGBShiftPass.enabled = false;
				}
				


				requestAnimationFrame( animate );

				object.rotation.x += 0.005;
				object.rotation.y += 0.01;

				postprocessor.render();
				stats.update();


			}

			SC.initialize({
			  client_id: 'b861cf4f67c435a1183dc13112b0f56f'
			});

			// stream track id 293
			SC.stream("/tracks/91058804", function(sound){
			  soundAPI.load(sound.url, function(soundAPI){
					soundAPI.loop(true).play();
				});
			});


			$(function(){

				currentMousePos = { x: -1, y: -1 };
			    $(document).mousemove(function(event) {
			        currentMousePos.x = event.pageX;
			        currentMousePos.y = event.pageY;
			    });
				webaudio	= new WebAudio();
				// create a sound
				soundAPI	= webaudio.createSound();
			    canvasCallback = $.Callbacks();
			    var prCodeInit = function(){
			      var $projDiv = $('#glamProcessing');
			      var canvasRef = $('<canvas id="glam"/>');
			      p1 = new Processing.loadSketchFromSources('glam', ['scripts/glam.pde']);
			      $projDiv.append(canvasRef); 
			      
			    };

			    var setup3JS = function(){
			    	setTimeout(function(){
			    		init();
			    		animate();
			    	}, 2000);
			    	
			    }

			    canvasCallback.add(prCodeInit);
    			canvasCallback.add(setup3JS);
    			canvasCallback.fire('setup3JS');
			    
			});

			function buildDisorder(){
				var geometry = new THREE.PlaneGeometry( $(window).width(), $(window).height() );
				uniforms1 = {
					time: { type: "f", value: 1.0 },
					resolution: { type: "v2", value: new THREE.Vector2() },
					surfacePosition: { type: "v2", value: new THREE.Vector2() },
					mouse: { type: "v2", value: new THREE.Vector2(currentMousePos.x, currentMousePos.y) }
				};
				//var matJoyDivision = new THREE.MeshBasicMaterial( {color: 0xffff00, side: THREE.DoubleSide} );
				var matJoyDivision = new THREE.ShaderMaterial( {

						uniforms: [ 'fragment_shader1', uniforms1 ],
						side: THREE.DoubleSide,
						vertexShader: document.getElementById( 'vertexShader' ).textContent,
						fragmentShader: document.getElementById( 'fragment_shader1').textContent


				} );

				var plane = new THREE.Mesh( geometry, matJoyDivision );
				scene.add( plane );

			}


	

		</script>



</body>
</html>